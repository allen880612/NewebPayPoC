# 藍新金流錯誤代碼表

## MPG 交易錯誤 (MPG01xxx - 參數錯誤)

| 代碼 | 原因 | 相關參數 |
|------|------|----------|
| MPG01002 | 時間戳記不可空白 | TimeStamp |
| MPG01005 | TokenTerm 不可空白/設定錯誤 | TokenTerm |
| MPG01008 | 分期參數設定錯誤 | InstFlag |
| MPG01009 | 商店代號不可空白 | MerchantID |
| MPG01010 | 程式版本設定錯誤 | Version |
| MPG01011 | 回傳規格設定錯誤 | RespondType |
| MPG01012 | 商店訂單編號不可空白/設定錯誤 | MerchantOrderNo (限英數+"_", 30字) |
| MPG01013 | 付款人電子信箱設定錯誤 | Email |
| MPG01014 | 網址設定錯誤 | ReturnURL/NotifyURL/CustomerURL/ClientBackURL |
| MPG01015 | 訂單金額不可空白/設定錯誤/超過限額 | Amt |
| MPG01016 | 檢查碼不可空白 | CheckValue |
| MPG01017 | 商品資訊不可空白 | ItemDesc |
| MPG01018 | 繳費有效期限設定錯誤 | ExpireDate |
| MPG01023 | 交易加密資料不可空白 | TradeInfo |
| MPG01024 | 交易加密 SHA 資料不可空白 | TradeSha |
| MPG01025 | 金融機構格式錯誤 | BankType (大小寫有區分) |
| MPG01026 | 金融機構格式錯誤，不接受 XXX | BankType (帶入不支援銀行) |
| MPG01027 | 一銀維護中，請選擇其他金融機構 | BankType |
| MPG01028 | 訂單細項格式錯誤 | ItemOrderNo |
| MPG01029 | 訂單金額與訂單細項總金額不相符 | Amt/ItemOrderNo |
| MPG01030 | 訂單細項品項編號不可重複 | ItemOrderNo |

## MPG 交易錯誤 (MPG02xxx - 驗證錯誤)

| 代碼 | 原因 | 解決方式 |
|------|------|----------|
| MPG02001 | 檢查碼錯誤 | 檢查 CheckValue 產生方式 |
| MPG02002 | 查無商店開啟任何金流服務 | 至後台啟用金流 |
| MPG02003 | 支付方式未啟用，請洽客服中心 | 聯繫藍新客服 |
| MPG02004 | 頁面已逾時失效，請重新確認 | TimeStamp 須 120 秒內, 檢查加密方式 |
| MPG02005 | 驗證資料錯誤(來源不合法) | **禁用 iframe/proxy**, 須用前景 Form POST |
| MPG02006 | 信用卡收單機構系統發生異常 | 聯繫藍新客服 |
| MPG02007 | 本商店強制指定需檢核轉出行，請先啟用智慧ATM2.0服務 | 啟用智慧 ATM2.0 |
| MPG02008 | SourceType 參數錯誤 | 智慧 ATM2.0 啟用時 SourceType 須為 2 |
| MPG02009 | 不可修改銀行代號與帳號時，須提供指定轉帳的銀行代號與帳號 | 帶入 SourceBankId, SourceAccountNo |
| MPG02010 | 此版本不支援，請升級至 v2.3 | 升級版本 |

## MPG 交易錯誤 (MPG03xxx - 支付錯誤)

| 代碼 | 原因 |
|------|------|
| MPG03001 | FormPost 加密失敗 / 建立支付失敗 |
| MPG03002 | 拒絕交易 IP / 交易取消 |
| MPG03003 | IP 交易次數限制 / 該筆交易資料不存在 |
| MPG03004 | 商店狀態已被暫停或關閉 / 該筆交易金融機構資料錯誤 |
| MPG03005 | 回傳參數資料不存在/解密失敗 / 該筆交易已付款成功 |
| MPG03006 | 該筆交易已請款成功 |
| MPG03007 | 該筆交易已退款 / 該筆訂單交易資訊不存在 |
| MPG03008 | 該筆訂單編號已存在 |
| MPG03009 | 交易失敗 (SHA256/TradeInfo 解密失敗/授權失敗) |
| MPG03010 | BitoPay 發生錯誤 / 驗證資料不存在或錯誤 |
| MPG03011 | BitoPay 發生逾時 / 訂單資料已不存在 |

## MPG 交易錯誤 (MPG05xxx - 信用卡驗證錯誤)

| 代碼 | 原因 |
|------|------|
| MPG05001 | 未有信用卡驗證資料 / 信用卡驗證資料解密失敗 |
| MPG05002 | 信用卡卡號長度不足 / 未有商店代號 / 本商店不支援此信用卡付款 |
| MPG05003 | 此信用卡不支援一次付清/分期付款/紅利付款 |
| MPG05004 | 發卡行暫時無法提供信用卡分期付款服務 |
| MPG05005 | 警示交易 |
| MPG05006 | 物流設定參數 LgsType 錯誤 (限 C2C 或 B2C) |
| MPG05007 | 請開啟其他支付方式，才能使用超商取貨不付款服務 |
| MPG05008 | 因金額限制關係，無法使用物流服務 (訂單金額需 < 20,000) |
| MPG05009 | 超商取貨服務未啟用 |

## 會員/欄位錯誤 (ACC/MEM)

| 代碼 | 原因 |
|------|------|
| ACC10005 | 會員已被暫時/永久停權，請洽客服中心 |
| MEM40008 | 必填欄位資料不可空白 |
| MEM40012 | 必填欄位資料傳遞錯誤 (PostData_ 空白) |
| MEM40013 | 必填欄位資料不齊全 |
| MEM40014 | 傳送時間錯誤 |

## 連線/資料錯誤 (NOR/TRA10xxx)

| 代碼 | 原因 |
|------|------|
| NOR1001 | 連線異常 |
| TRA10001 | 商店資料取得失敗 / 查詢交易失敗 |
| TRA10002 | 查無該筆交易資料 |
| TRA10003 | 商店代號錯誤 / 金額必須為數字 |
| TRA10004 | 交易金額不符 |
| TRA10005 | 發動 API 參數錯誤 |
| TRA10008 | 資料加密錯誤 (PostData_ 解密失敗) |
| TRA10009 | 商店代號不可空白 |
| TRA10012 | 商店代號停用 |
| TRA10013 | 商店信用卡資格停用 |
| TRA10015 | 網路連線失敗 |
| TRA10018 | 資料不足 |
| TRA10021 | 查無該筆交易或該筆交易不為信用卡交易 |

## 取消授權錯誤 (TRA2xxxx)

| 代碼 | 原因 | 說明 |
|------|------|------|
| TRA20001 | 取消授權需批次處理 | **非錯誤**，等待銀行處理 |
| TRA20002 | 該筆交易不允許取消授權 | |
| TRA20003 | 該筆交易無法進行此授權動作 | |
| TRA20004 | 取消授權失敗 | |
| TRA20005 | 該筆交易已請款，無法取消授權 | |
| TRA20006 | 傳入資料不完整 | |
| TRA20007 | 該筆交易已取消授權 | |

## ⚠️ 請退款錯誤 (重要)

### 狀態相關錯誤

| 代碼 | 原因 | 處理建議 |
|------|------|----------|
| TRA10026 | 此訂單非授權成功狀態，不可請款 | 確認授權是否成功 |
| TRA10027 | 此訂單已申請過請款，不可重覆請款 | 檢查 CloseStatus |
| TRA10035 | 該交易非授權成功或已請款完成狀態 | **重要**：退款前須先請款 |
| TRA10047 | 該筆交易尚未發動撥款，無法執行退款 | **重要**：先執行請款 |
| TRA10048 | 該交易正在請款狀態 | 等待請款完成 |
| TRA10049 | 該交易正在退款狀態 | 等待退款完成 |

### 金額相關錯誤

| 代碼 | 原因 |
|------|------|
| TRA10028 | 請退款金額超過授權金額，請確認 |
| TRA10036 | 已超過剩餘可退款金額，請確認 |
| TRA10039 | 退款金額已超過請款金額，請確認 |
| TRA10050 | 金額不符 |
| TRA10077 | 只能退未撥金額 |

### 時間/期限相關錯誤

| 代碼 | 原因 |
|------|------|
| TRA10029 | 請款超過授權日 N 天，已不得請(退)款 |
| TRA10095 | 此筆交易已過關帳時間，不可取消 |

### 交易類型限制錯誤

| 代碼 | 原因 | 說明 |
|------|------|------|
| TRA10031 | 銀聯卡交易只接受全額請款 | 銀聯卡不支援部分請款 |
| TRA10058 | 動態貨幣轉換交易只接授全額請款 | DCC 不支援部分請款 |
| TRA10070 | 銀聯卡交易無需請款 | 銀聯卡已自動請款 |
| TRA10675 | 紅利交易只接授全額請退款 | 紅利不支援部分退款 |
| TRA10678 | 銀聯卡退款失敗 | |

### 處理中/失敗狀態錯誤

| 代碼 | 原因 |
|------|------|
| TRA10030 | 請款/退款資料新增失敗 / 模擬信用卡請款失敗 |
| TRA10045 | 該筆交易正在退款中或退款失敗 |
| TRA10046 | 該筆交易撥款狀態異常，無法執行退款 |
| TRA10051 | 取消授權失敗 |
| TRA10094 | 資料取消失敗 |

### 參數格式錯誤

| 代碼 | 原因 |
|------|------|
| TRA10032 | 單號類型只能為數字 1 或 2 (IndexType) |
| TRA10033 | 選擇使用商店自訂單號不可空白 |
| TRA10037 | 商家自訂單號錯誤，只允許英數字及_符號 |
| TRA10038 | 選擇使用系統單號格式錯誤 |
| TRA10041 | 網址格式錯誤 |
| TRA10054 | 檢查碼 CheckValue 有錯誤 |

### 一般請退款錯誤

| 代碼 | 原因 |
|------|------|
| TRA20011 | 該筆交易不允許請款 |
| TRA20012 | 該筆交易不允許退款 |
| TRA20013 | 該筆交易請款金額超過可請款金額 |
| TRA20014 | 該筆交易退款金額超過可退款金額 |
| TRA20015 | 請退款作業失敗 |
| TRA20016 | 該筆交易已請款 |
| TRA20017 | 該筆交易已退款 |
| TRA20018 | 該筆交易不允許取消請退款 |
| TRA20019 | 取消請退款作業失敗 |
| TRA20020 | 該筆交易已取消請款 |
| TRA20021 | 該筆交易已取消退款 |

## ⚠️ 速率限制錯誤 (Rate Limit)

| 代碼 | 原因 | 解鎖時間 |
|------|------|----------|
| TRA10071 | 因查無交易資料次數已達上限，已鎖定交易查詢功能 | **4 小時** |
| TRA10702 | 因達到執行請退款筆數上限，您的商店暫時無法使用本功能 | **1 小時** |

> ⚠️ **注意**：避免頻繁查詢不存在的訂單，以免觸發速率限制

## 信用卡授權錯誤

| 代碼 | 原因 | 處理建議 |
|------|------|----------|
| AUTH0001 | 授權失敗 | 請消費者確認卡片資訊 |
| AUTH0002 | 風險控管阻擋 | 聯繫藍新客服 |
| AUTH0003 | 3D 驗證失敗 | 請消費者重新驗證 |
| AUTH0004 | 授權逾時 | 請重新發起交易 |
| AUTH0005 | 卡號無效 | 請消費者確認卡號 |
| AUTH0006 | 卡片過期 | 請使用有效卡片 |
| AUTH0007 | 交易金額超過限額 | 調整金額或聯繫發卡銀行 |
| AUTH0008 | 拒絕授權 | 聯繫發卡銀行 |
| AUTH0009 | 卡片餘額不足 | 請使用其他卡片 |

---

## 常見問題排查

### Q: 出現 MPG02004 頁面已逾時失效

**可能原因**：
1. TimeStamp 產生後超過 120 秒才發動 API
2. 參數名稱或格式與文件不一致
3. EncryptType 與實際加密方式不符

**解決方式**：
```typescript
// 確保 TimeStamp 是當前秒數
const timestamp = Math.floor(Date.now() / 1000);
```

### Q: 出現 MPG02005 來源不合法

**原因**：使用 iframe、proxy 或幕後 HTTP POST 方式使用 MPG 頁面

**解決方式**：
```html
<!-- 正確：前景 Form POST -->
<form method="POST" action="https://ccore.newebpay.com/MPG/mpg_gateway">
  <input name="MerchantID" value="..." />
  <input name="TradeInfo" value="..." />
  <input name="TradeSha" value="..." />
  <input name="Version" value="2.3" />
  <button type="submit">前往付款</button>
</form>
```

### Q: 常常收不到 Notify 回傳

**檢查項目**：
1. NotifyURL 是否正確設定
2. 伺服器是否回應 HTTP 200
3. 防火牆是否阻擋藍新 IP
4. 非即時支付須等繳費完成才會 Notify

**Retry 機制**：藍新會重試 3 次，若皆未收到 HTTP 200 則失敗

### Q: 加解密結果不正確

**檢查項目**：
1. HashKey 和 HashIV 是否正確 (區分大小寫)
2. 加密模式是否與 EncryptType 參數一致
3. AES 使用 PKCS7 Padding
4. SHA256 結果須轉大寫

### Q: 退款時出現 TRA10035 或 TRA10047

**原因**：尚未執行請款就嘗試退款

**解決流程**：
```
1. 確認交易狀態 (Query API)
2. 若 CloseStatus = 0，先執行請款 (CloseType=1)
3. 等待 CloseStatus = 3 (請款完成)
4. 再執行退款 (CloseType=2)
```

### Q: 查詢 API 出現 TRA10071 被鎖定

**原因**：1 小時內查詢錯誤訂單編號次數過多

**解決方式**：
1. 等待 4 小時自動解鎖
2. 避免查詢不存在的訂單
3. 建議本地快取訂單資訊

### Q: 請退款 API 出現 TRA10702 被鎖定

**原因**：1 小時內執行請退款次數過多

**解決方式**：
1. 等待 1 小時自動解鎖
2. 批次處理時注意頻率控制
